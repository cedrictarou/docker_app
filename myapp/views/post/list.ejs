<!DOCTYPE html>
<html lang="ja" class="h-100">

<head>
  <title>
    All Posts
  </title>
  <!-- cssの読み込み -->
  <%- include('../_share/stylesheets.ejs') %>
</head>

<body class="d-flex flex-column h-100">
  <header>
    <%- include('../_share/navbar.ejs') %>
  </header>

  <!-- Begin page content -->
  <main role="main" class="flex-shrink-0">
    <div class="container">
      <div class="mb-5">
        <h2>みんなの投稿</h2>
      </div>
      <% if (posts) { %>
        <% posts.forEach( post=> { %>
          <div class="card mb-3">
            <div class="card-body">
              <h3 class="card-title">
                <%= post.title %>
              </h3>
              <p class="card-text">
                <%= post.content %>
              </p>
              <div class="post-user">
                <div>
                  <button class="btn p-0">
                    <i class="fas fa-user"></i>
                  </button>
                  <span>
                    <%= post.User.username %>
                  </span>
                </div>
              </div>
              <div class="heart_icon">
                <div>
                  <form>
                    <div class="form-group">
                      <button type="submit" data-action="/like/create" data-method="POST" name="postId"
                        class="likeBtn btn p-0">
                        <i class="far fa-heart"></i>
                      </button>
                      <span class="likeNum">
                        <%= post.likeCounts %>
                      </span>
                    </div>
                  </form>
                </div>
              </div>
              <div class="mt-3">
                <!-- ログインしているユーザーの投稿だけ編集削除できるようにする -->
                <% const postId=post.id %>
                  <% if (locals.user.id===post.user_id) { %>
                    <form>
                      <button class="editBtn btn btn-primary" type="submit" data-action="/post/edit/<%= postId %>"
                        data-method="get">編集</button>
                      <button class="deleteBtn btn btn-danger" type="submit"
                        data-action="/post/delete/<%= postId %>?_method=DELETE" data-method="post">削除</button>
                    </form>
                    <% } %>
              </div>
            </div>
          </div>
          <% }) %>
            <% } %>

    </div>
  </main>

  <%- include('../_share/footer.ejs') %>
    <%- include('../_share/javascripts.ejs') %>
      <script src="/javascripts/post/edit.js"></script>
      <script src="/javascripts/likeBtn/likeBtn.js"></script>
      <script>
        // formを操作する
        // buttonタイプがsubmitのものを全て取得する
        const likeBtns = document.querySelectorAll(".likeBtn");
        // 取得したlikeBtnsのそれぞれの要素にイベントを追加する
        likeBtns.forEach((likeBtn) => {
          likeBtn.addEventListener('click', (event) => {
            // 親要素を取得する
            const formElement = likeBtn.closest('form');
            // method属性を追加
            formElement.setAttribute('method', likeBtn.dataset.method);
            // action属性を追加
            formElement.setAttribute('action', likeBtn.dataset.action);
            event.preventDefault();
            // formElement.submit();
          });
        });
      </script>
</body>

</html>